<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>py2vision.stereo.standard_stereo &mdash; py2vision 1.0 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> py2vision
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../module_compute.html">Compute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_datasets_loader.html">Datasets loader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_image_process.html">Image process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_input_output.html">Inputs and Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_models.html">Tensorflow models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_recognition.html">Object detection (Recognition)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_stereo.html">Stereo Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_utils.html">Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">py2vision</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>py2vision.stereo.standard_stereo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for py2vision.stereo.standard_stereo</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="nn">cv</span> 
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">py2vision.stereo.stereo_builder</span> <span class="kn">import</span> <span class="n">StereoSystemBuilder</span>
<span class="kn">from</span> <span class="nn">py2vision.stereo.match_method</span> <span class="kn">import</span> <span class="n">Matcher</span>
<span class="kn">from</span> <span class="nn">py2vision.input_output.camera</span> <span class="kn">import</span> <span class="n">Camera</span>
<span class="kn">from</span> <span class="nn">py2vision.utils.draw</span> <span class="kn">import</span> <span class="n">draw_lines</span>
<span class="kn">from</span> <span class="nn">py2vision.compute.error_compute</span> <span class="kn">import</span> <span class="n">re_projection_error</span>


<div class="viewcode-block" id="StandardStereo"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereo">[docs]</a><span class="k">class</span> <span class="nc">StandardStereo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An emulation of a real world stereo system with his relevant parameters, like fundamental matrix, rotation matrix, translation matrix and esential matrix. </span>

<span class="sd">    Attributes:</span>
<span class="sd">        camL: left camera instance.</span>
<span class="sd">        camR: right camera instance.</span>
<span class="sd">        fish_eye: A boolean if is true it will calibrate with cv2.fisheye.calibrate if no it&#39;ll use normal calibration, fish eye is recomended when cameras has an field of view &gt; 160.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam_left</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">cam_right</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">fish_eye</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fish_eye</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fish_eye has to be a boolean&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">camL</span> <span class="o">=</span> <span class="n">cam_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camR</span> <span class="o">=</span> <span class="n">cam_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">=</span> <span class="n">fish_eye</span>
    
<div class="viewcode-block" id="StandardStereo.take_dual_photos"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereo.take_dual_photos">[docs]</a>    <span class="k">def</span> <span class="nf">take_dual_photos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_photos</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">save_dir_left</span><span class="o">=</span><span class="s2">&quot;images_left&quot;</span><span class="p">,</span> <span class="n">save_dir_right</span><span class="o">=</span><span class="s2">&quot;images_right&quot;</span><span class="p">,</span> <span class="n">prefix_name</span><span class="o">=</span><span class="s2">&quot;photo&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A simple way to take photos in console and save in a folder.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            num_photos: number of photos to take, 15 by default.</span>
<span class="sd">            save_dir_left: directory name where the left photos will be saved.</span>
<span class="sd">            save_dir_right: directory name where the right photos will be saved.</span>
<span class="sd">            prefix_name: A prefix for the names of the photos.</span>

<span class="sd">        Raises:</span>
<span class="sd">            OSError: if folder exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initial directory</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="c1"># make directory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir_left</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>   
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir_right</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>   


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;webcam&#39;</span><span class="p">:</span>
            <span class="n">capL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">capL</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot open left camera&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;webcam&#39;</span><span class="p">:</span>
            <span class="n">capR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">capR</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot open right camera&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_photos</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please press enter to take a photo&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
                    <span class="n">img_respL</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                    <span class="n">img_arrL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">img_respL</span><span class="o">.</span><span class="n">content</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">frameL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">img_arrL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">img_respR</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                    <span class="n">img_arrR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">img_respR</span><span class="o">.</span><span class="n">content</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">frameR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">img_arrR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameR</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span> <span class="ow">or</span> <span class="s1">&#39;webcam&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">frameL</span> <span class="o">=</span> <span class="n">capL</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">img_respR</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                    <span class="n">img_arrR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">img_respR</span><span class="o">.</span><span class="n">content</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">frameR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">img_arrR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;webcam: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameR</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span> <span class="ow">or</span> <span class="s1">&#39;webcam&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">type_source</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">frameR</span> <span class="o">=</span> <span class="n">capR</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">img_respL</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                    <span class="n">img_arrL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">img_respL</span><span class="o">.</span><span class="n">content</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">frameL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">img_arrL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;webcam: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameR</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;streaming: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameL</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">frameL</span> <span class="o">=</span> <span class="n">capL</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">frameR</span> <span class="o">=</span> <span class="n">capR</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;webcam: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;webcam: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">frameR</span><span class="p">)</span>
                <span class="n">input_key</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">input_key</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="c1">#space pressed</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">save_dir_left</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix_name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">frameL</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved as </span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix_name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">save_dir_right</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix_name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">frameR</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved as </span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix_name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> photos left&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_photos</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">input_key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
                    <span class="c1">#esc pressed</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Escape hit, closing...&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">input_key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
                <span class="c1">#esc pressed</span>
                <span class="k">break</span>
        <span class="n">cv</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
        <span class="c1"># restore to initial directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>

<div class="viewcode-block" id="StandardStereo.calibrate"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereo.calibrate">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images_left_path</span><span class="p">,</span> <span class="n">images_right_path</span><span class="p">,</span> <span class="n">pattern_type</span><span class="o">=</span><span class="s1">&#39;chessboard&#39;</span><span class="p">,</span> <span class="n">pattern_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute intrinsics and extrinsics parameters for two cameras at once.</span>
<span class="sd">        Note: if you want a good calibration your images in &#39;images_left_path&#39; and &#39;images_right_path&#39; have to follow a format for example: example/left_images/photo_1.jpg and example/right_images/photo_1.jpg the number is important because calibrate method order the pair of images with sorted method.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            images_left_path: folder where is saved left calibration pattern photos.</span>
<span class="sd">            images_right_path: folder where is saved right calibration pattern photos.</span>
<span class="sd">            pattern_type: It can be &quot;circles&quot; pattern or &quot;chessboard&quot; pattern (default).</span>
<span class="sd">            pattern_size: If pattern_type is &quot;chessboard&quot;  this the Number of inner corners per a chessboard row and column. But If pattern_type is &quot;circles&quot; this will be the number of circles per row and column. </span>
<span class="sd">            show: if is true it show corners or centers found by calibration algorithm  at each iteration.</span>
<span class="sd">        </span>
<span class="sd">        Returns: </span>
<span class="sd">            Three floats, The first is the reprojection error in left side,  the another one is right side</span>
<span class="sd">            and the third one is rms error (these have to be less than 1).</span>

<span class="sd">        Raises:</span>
<span class="sd">            OSError: If didn&#39;t find photos on images_left_path or images_right_path folders.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;chessboard&quot;</span><span class="p">,</span> <span class="s2">&quot;circles&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pattern_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_patterns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pattern_type only can be &#39;chessboard&#39; or &#39;circles&#39;&quot;</span><span class="p">)</span> 
        <span class="c1"># adjust image path</span>
        <span class="n">images_left</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">images_left_path</span><span class="p">)</span>
        <span class="n">images_right</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">images_right_path</span><span class="p">)</span>
        <span class="c1"># available formats</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;*.png&#39;</span><span class="p">,</span> <span class="s1">&#39;*.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;*.bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;*.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;*.raw&#39;</span><span class="p">]</span>
        <span class="c1"># get files names</span>
        <span class="n">filesL</span> <span class="o">=</span> <span class="p">[</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">((</span><span class="n">images_left</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">]</span>
        <span class="n">filesR</span> <span class="o">=</span> <span class="p">[</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">((</span><span class="n">images_right</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">]</span>
        <span class="c1"># flatting files list</span>
        <span class="n">imagesL</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">filesL</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">imagesR</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">filesR</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">imagesL</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imagesL</span><span class="p">)</span>
        <span class="n">imagesR</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imagesR</span><span class="p">)</span>
        <span class="c1"># termination criteria</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        
        <span class="c1"># prepare object points, like (0,0,0), (1,0,0), (2,0,0) ....,(6,5,0)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">objp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">objp</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">objp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">pattern_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Arrays to store object points and image points from all the images.</span>
        <span class="n">objpoints</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 3d point in real world space</span>
        <span class="n">imgpointsL</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 2d points in image plane.</span>
        <span class="n">imgpointsR</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 2d points in image plane.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagesL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagesR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span>
            <span class="k">for</span> <span class="n">imgLeft</span><span class="p">,</span> <span class="n">imgRight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imagesL</span><span class="p">,</span> <span class="n">imagesR</span><span class="p">):</span>
                <span class="n">imgL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgLeft</span><span class="p">)</span>
                <span class="n">imgR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgRight</span><span class="p">)</span>
                <span class="n">grayL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">imgL</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
                <span class="n">grayR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">imgR</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

                <span class="c1"># Find the chess board corners</span>
                <span class="k">if</span> <span class="n">pattern_type</span> <span class="o">==</span> <span class="s1">&#39;chessboard&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">retL</span><span class="p">,</span> <span class="n">cornersL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findChessboardCorners</span><span class="p">(</span><span class="n">grayL</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">retR</span><span class="p">,</span> <span class="n">cornersR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findChessboardCorners</span><span class="p">(</span><span class="n">grayR</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pattern_type</span> <span class="o">==</span> <span class="s1">&#39;circles&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">retL</span><span class="p">,</span> <span class="n">cornersL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findCirclesGrid</span><span class="p">(</span><span class="n">grayL</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">retR</span><span class="p">,</span> <span class="n">cornersR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findCirclesGrid</span><span class="p">(</span><span class="n">grayR</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pattern_type</span> <span class="o">==</span> <span class="s1">&#39;chessboard&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">retL</span><span class="p">,</span> <span class="n">cornersL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findChessboardCorners</span><span class="p">(</span><span class="n">grayL</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_ADAPTIVE_THRESH</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_FAST_CHECK</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_NORMALIZE_IMAGE</span><span class="p">)</span>
                    <span class="n">retR</span><span class="p">,</span> <span class="n">cornersR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findChessboardCorners</span><span class="p">(</span><span class="n">grayR</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_ADAPTIVE_THRESH</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_FAST_CHECK</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_NORMALIZE_IMAGE</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pattern_type</span> <span class="o">==</span> <span class="s1">&#39;circles&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">retL</span><span class="p">,</span> <span class="n">cornersL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findCirclesGrid</span><span class="p">(</span><span class="n">grayL</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_ADAPTIVE_THRESH</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_FAST_CHECK</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_NORMALIZE_IMAGE</span><span class="p">)</span>
                    <span class="n">retR</span><span class="p">,</span> <span class="n">cornersR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findCirclesGrid</span><span class="p">(</span><span class="n">grayR</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_ADAPTIVE_THRESH</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_FAST_CHECK</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_CB_NORMALIZE_IMAGE</span><span class="p">)</span>

                <span class="c1"># If found, add object points, image points (after refining them)</span>
                <span class="k">if</span> <span class="n">retL</span> <span class="ow">and</span> <span class="n">retR</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                    <span class="n">objpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objp</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>   
                        <span class="n">cornersL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cornerSubPix</span><span class="p">(</span><span class="n">grayL</span><span class="p">,</span> <span class="n">cornersL</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">criteria</span><span class="p">)</span>
                        <span class="n">cornersR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cornerSubPix</span><span class="p">(</span><span class="n">grayR</span><span class="p">,</span> <span class="n">cornersR</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">criteria</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cornersL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cornerSubPix</span><span class="p">(</span><span class="n">grayL</span><span class="p">,</span> <span class="n">cornersL</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">criteria</span><span class="p">)</span>
                        <span class="n">cornersR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cornerSubPix</span><span class="p">(</span><span class="n">grayR</span><span class="p">,</span> <span class="n">cornersR</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">criteria</span><span class="p">)</span>
                    <span class="n">imgpointsL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cornersL</span><span class="p">)</span>
                    <span class="n">imgpointsR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cornersR</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                    <span class="c1"># Draw and display the corners</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">drawChessboardCorners</span><span class="p">(</span><span class="n">imgL</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="n">cornersL</span><span class="p">,</span> <span class="n">retL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="n">imgLeft</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgLeft</span><span class="p">,</span> <span class="n">imgL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">drawChessboardCorners</span><span class="p">(</span><span class="n">imgR</span><span class="p">,</span> <span class="n">pattern_size</span><span class="p">,</span> <span class="n">cornersR</span><span class="p">,</span> <span class="n">retR</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="n">imgRight</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgRight</span><span class="p">,</span> <span class="n">imgR</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">6000</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="n">cv</span><span class="o">.</span><span class="n">CALIB_FIX_INTRINSIC</span>
                <span class="c1"># Here we fix the intrinsic camara matrixes so that only Rot, Trns, Emat and Fmat are calculated.</span>
                <span class="c1"># Hence intrinsic parameters are the same </span>

                <span class="n">criteria_stereo</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">CALIB_RECOMPUTE_EXTRINSIC</span> <span class="o">+</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">CALIB_FIX_SKEW</span>
                <span class="n">criteria_stereo</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">rvecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objpoints</span><span class="p">))]</span>
                <span class="n">tvecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objpoints</span><span class="p">))]</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This step is performed to transformation between the two cameras and calculate Essential and Fundamental matrix</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calibrating estereo...&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">rms_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_matrix</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">stereoCalibrateExtended</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">grayL</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">criteria_stereo</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rms_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">,</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">stereoCalibrate</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">grayL</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CALIB_FIX_INTRINSIC</span><span class="p">,</span> <span class="n">criteria_stereo</span><span class="p">)</span>
                <span class="n">errorL</span> <span class="o">=</span> <span class="n">re_projection_error</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">rvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">tvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Left camera error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errorL</span><span class="p">))</span>
                <span class="n">errorR</span> <span class="o">=</span> <span class="n">re_projection_error</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">rvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">tvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Right camera error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errorR</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;system calibrated&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Camera parameters hasn&#39;t fixed&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixing left camera...&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">errorL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">rvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">tvecs</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">calibrateCamera</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="n">grayL</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">heightL</span><span class="p">,</span> <span class="n">widthL</span> <span class="o">=</span> <span class="n">imgL</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">getOptimalNewCameraMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="p">(</span><span class="n">widthL</span><span class="p">,</span> <span class="n">heightL</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">widthL</span><span class="p">,</span> <span class="n">heightL</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errorL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">rvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">tvecs</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="n">grayL</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rvecs</span><span class="p">,</span> <span class="n">tvecs</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Left camera error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errorL</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixing Right camera...&quot;</span><span class="p">)</span>
                <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">errorR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">rvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">tvecs</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">calibrateCamera</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="n">grayR</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">heightR</span><span class="p">,</span> <span class="n">widthR</span> <span class="o">=</span> <span class="n">imgL</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">getOptimalNewCameraMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="p">(</span><span class="n">widthR</span><span class="p">,</span> <span class="n">heightR</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">widthR</span><span class="p">,</span> <span class="n">heightR</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errorR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">rvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">tvecs</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="n">grayR</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rvecs</span><span class="p">,</span> <span class="n">tvecs</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span><span class="o">+</span><span class="n">cv</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Right camera error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errorR</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calibrating estereo...&quot;</span><span class="p">)</span>
                <span class="c1"># This step is performed to transformation between the two cameras and calculate Essential and Fundamenatl matrix</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ret_stereo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_matrix</span><span class="p">,</span> <span class="n">rms_error</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">stereoCalibrateExtended</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">grayL</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">criteria_stereo</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rms_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">,</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">stereoCalibrate</span><span class="p">(</span><span class="n">objpoints</span><span class="p">,</span> <span class="n">imgpointsL</span><span class="p">,</span> <span class="n">imgpointsR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">grayL</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CALIB_FIX_INTRINSIC</span><span class="p">,</span> <span class="n">criteria_stereo</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;system calibrated&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagesL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find any image in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">images_left_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagesR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find any image in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">images_right_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">errorL</span><span class="p">,</span> <span class="n">errorR</span><span class="p">,</span> <span class="n">rms_error</span></div>

<div class="viewcode-block" id="StandardStereo.rectify"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereo.rectify">[docs]</a>    <span class="k">def</span> <span class="nf">rectify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_left__dims</span><span class="p">,</span> <span class="n">image_right_dims</span><span class="p">,</span> <span class="n">export_file_name</span><span class="o">=</span><span class="s2">&quot;stereoMap&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">export_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute stereo rectification maps and export left and right stereo maps in xml format. Note: you will need to calibrate first</span>
<span class="sd">        </span>
<span class="sd">        Args: </span>
<span class="sd">            image_left__dims: a tuple or list with left image (width, height).</span>
<span class="sd">            image_right_dims: a tuple or list with right image (width, height).</span>
<span class="sd">            export_file_name: personalize the name of output file.</span>
<span class="sd">            alpha: free scaling parameter. If it is -1 or absent, the function performs the default scaling. Otherwise, the parameter should be between 0 and 1. alpha=0 means that the rectified images are zoomed and shifted so that only valid pixels are visible (no black areas after rectification). alpha=1 (default) means that the rectified image is decimated and shifted so that all the pixels from the original images from the cameras are retained in the rectified images (no source image pixels are lost). Any intermediate value yields an intermediate result between those two extreme cases (Only apply for no fish eye cameras). </span>
<span class="sd">            output_size: New image resolution after rectification. When (0,0) is passed (default), it is set to the original image Size. Setting it to a larger value can help you preserve details in the original image, especially when there is a big radial distortion.</span>
<span class="sd">            export_file: if is true this method will save the parameters in an xml with the name in export_file_name. </span>
<span class="sd">        </span>
<span class="sd">        Raises: </span>
<span class="sd">            AttributeError: If haven&#39;t calibrated before, you need all parameters of calibrate() method.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_left__dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_right_dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;image_left_dims and image_right_dims must have a length of 2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_eye</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">rectL</span><span class="p">,</span> <span class="n">rectR</span><span class="p">,</span> <span class="n">projMatrixL</span><span class="p">,</span> <span class="n">projMatrixR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">stereoRectify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">image_left__dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">CALIB_ZERO_DISPARITY</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">rectL</span><span class="p">,</span> <span class="n">projMatrixL</span><span class="p">,</span> <span class="n">image_left__dims</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CV_16SC2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">rectR</span><span class="p">,</span> <span class="n">projMatrixR</span><span class="p">,</span> <span class="n">image_right_dims</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CV_16SC2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rectL</span><span class="p">,</span> <span class="n">rectR</span><span class="p">,</span> <span class="n">projMatrixL</span><span class="p">,</span> <span class="n">projMatrixR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">stereoRectify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">image_left__dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CALIB_ZERO_DISPARITY</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapL</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">rectL</span><span class="p">,</span> <span class="n">projMatrixL</span><span class="p">,</span> <span class="n">image_left__dims</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CV_16SC2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapR</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fisheye</span><span class="o">.</span><span class="n">initUndistortRectifyMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="o">.</span><span class="n">dist_coeffs</span><span class="p">,</span> <span class="n">rectR</span><span class="p">,</span> <span class="n">projMatrixR</span><span class="p">,</span> <span class="n">image_right_dims</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CV_16SC2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_file</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving parameters!&quot;</span><span class="p">)</span>
                <span class="n">cv_file</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">FileStorage</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">export_file_name</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">FILE_STORAGE_WRITE</span><span class="p">)</span>

                <span class="n">cv_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stereoMapL_x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapL</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cv_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stereoMapL_y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapL</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cv_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stereoMapR_x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapR</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cv_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stereoMapR_y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapR</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">cv_file</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please calibrate first!&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="StandardStereo.get_stereo_maps"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereo.get_stereo_maps">[docs]</a>    <span class="k">def</span> <span class="nf">get_stereo_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads stereo maps parameters from a xml file</span>
<span class="sd">        </span>
<span class="sd">        Args: </span>
<span class="sd">            path: path where is saved xml file. (Note: if you don&#39;t have stereo maps you can use calibrate method first, then use rectify method and pass true in export file argument)</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="c1"># file storage read</span>
        <span class="n">cv_file</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">FileStorage</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">FILE_STORAGE_READ</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cv_file</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Looks like </span><span class="si">{}</span><span class="s2"> doesn&#39;t exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">temp_stereoMapL</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_stereoMapR</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_stereoMapL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_file</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s1">&#39;stereoMapL_x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mat</span><span class="p">())</span>
        <span class="n">temp_stereoMapL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_file</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s1">&#39;stereoMapL_y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mat</span><span class="p">())</span>
        <span class="n">temp_stereoMapR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_file</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s1">&#39;stereoMapR_x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mat</span><span class="p">())</span>
        <span class="n">temp_stereoMapR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_file</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="s1">&#39;stereoMapR_y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mat</span><span class="p">())</span>
        <span class="c1"># copy to class attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapL</span> <span class="o">=</span> <span class="n">temp_stereoMapL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stereoMapR</span> <span class="o">=</span> <span class="n">temp_stereoMapR</span>
        <span class="n">cv_file</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="StandardStereo.print_parameters"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereo.print_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">print_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">one_camera_parameters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;matrix&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_coeffs&#39;</span><span class="p">],</span> <span class="n">stereo_parameters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;rot&#39;</span><span class="p">,</span> <span class="s1">&#39;trans&#39;</span><span class="p">,</span> <span class="s1">&#39;e_matrix&#39;</span><span class="p">,</span> <span class="s1">&#39;f_matrix&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Print required individual camera parameters and stereo parameters already defined.</span>

<span class="sd">        Args: </span>
<span class="sd">            one_camera_parameters: All elements in list  will be printed, they match with cameras parameters.</span>
<span class="sd">            stereo_parameters: All elements in list  will be printed, they match with stereo parameters. </span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Left camera:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">one_camera_parameters</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camL</span><span class="p">,</span> <span class="n">attr</span><span class="p">)))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Right camera:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">one_camera_parameters</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camR</span><span class="p">,</span> <span class="n">attr</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stereo:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">stereo_parameters</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="StandardStereoBuilder"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder">[docs]</a><span class="k">class</span> <span class="nc">StandardStereoBuilder</span><span class="p">(</span><span class="n">StereoSystemBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement methods to get depth using OpenCV matchers like SGBM or BM.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        camL: left camera instance.</span>
<span class="sd">        camR: right camera instance.</span>
<span class="sd">        stereo_maps_path: an xml with Stereo rectification maps</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam_left</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">cam_right</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">stereo_maps_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A fresh builder instance should contain a blank product object, which is used in further assembly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">cam_left</span><span class="p">,</span> <span class="n">cam_right</span><span class="p">,</span> <span class="n">stereo_maps_path</span><span class="p">)</span>

<div class="viewcode-block" id="StandardStereoBuilder.reset"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam_left</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">cam_right</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">stereo_maps_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialitation of product</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product</span> <span class="o">=</span> <span class="n">StandardStereo</span><span class="p">(</span><span class="n">cam_left</span><span class="p">,</span> <span class="n">cam_right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="o">.</span><span class="n">get_stereo_maps</span><span class="p">(</span><span class="n">stereo_maps_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="StandardStereoBuilder.get_product"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.get_product">[docs]</a>    <span class="k">def</span> <span class="nf">get_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return: StandardStereo builded object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span></div>

<div class="viewcode-block" id="StandardStereoBuilder.pre_process"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.pre_process">[docs]</a>    <span class="k">def</span> <span class="nf">pre_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameL</span><span class="p">,</span> <span class="n">frameR</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; First, it transform from BGR to gray, next apply rectification and finally apply pyramid subsampling.</span>
<span class="sd">        </span>
<span class="sd">        Args: </span>
<span class="sd">            frameL: it&#39;s the left frame</span>
<span class="sd">            frameR: it&#39;s the right frame</span>
<span class="sd">            downsample: if it is true, it will apply blurry in both frames and downsamples it. The downsampling factor just can be 2, 4, 8, 16, 32, 64. If downsample factor is 1 or None or False won&#39;t apply downsampling.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Both frames to apply stereo correspondence or apply more processing to the images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">downsample</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="n">n_downsamples</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;downsample only can be 2, 4, 8, 16, 32, 64&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_downsamples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">downsample</span><span class="p">)</span>
            <span class="n">n_downsamples</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">img_left_gray</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frameL</span><span class="p">,</span><span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">img_right_gray</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frameR</span><span class="p">,</span><span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

        <span class="c1"># Applying stereo image rectification on the left image</span>
        <span class="n">rectified_left</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">img_left_gray</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="o">.</span><span class="n">stereoMapL</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="o">.</span><span class="n">stereoMapL</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cv</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Applying stereo image rectification on the right image</span>
        <span class="n">rectified_right</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">img_right_gray</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="o">.</span><span class="n">stereoMapR</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="o">.</span><span class="n">stereoMapR</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cv</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_downsamples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_downsamples</span><span class="p">):</span>
                <span class="n">rectified_left</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">pyrDown</span><span class="p">(</span><span class="n">rectified_left</span><span class="p">)</span>
                <span class="n">rectified_right</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">pyrDown</span><span class="p">(</span><span class="n">rectified_right</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">rectified_left</span><span class="p">,</span> <span class="n">rectified_right</span></div>
    
<div class="viewcode-block" id="StandardStereoBuilder.find_epilines"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.find_epilines">[docs]</a>    <span class="k">def</span> <span class="nf">find_epilines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameL</span><span class="p">,</span> <span class="n">frameR</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Draw epilines to both frames.</span>
<span class="sd">        </span>
<span class="sd">        Args: </span>
<span class="sd">            frameL: it&#39;s the left frame.</span>
<span class="sd">            frameR: it&#39;s the right frame.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Two elements, the left and right frame with epilines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sift</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
        <span class="c1"># find the keypoints and descriptors with SIFT</span>
        <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">frameL</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">frameR</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># FLANN parameters</span>
        <span class="n">FLANN_INDEX_KDTREE</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">index_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">FLANN_INDEX_KDTREE</span><span class="p">,</span> <span class="n">trees</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">search_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checks</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">flann</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">FlannBasedMatcher</span><span class="p">(</span><span class="n">index_params</span><span class="p">,</span><span class="n">search_params</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span><span class="n">des2</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pts1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pts2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ratio test as per Lowe&#39;s paper</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="n">pts2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kp2</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                <span class="n">pts1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kp1</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

        <span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">pts1</span><span class="p">)</span>
        <span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findFundamentalMat</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span><span class="n">pts2</span><span class="p">,</span><span class="n">cv</span><span class="o">.</span><span class="n">FM_LMEDS</span><span class="p">)</span>
        <span class="c1"># We select only inlier points</span>
        <span class="n">pts1</span> <span class="o">=</span> <span class="n">pts1</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pts2</span> <span class="o">=</span> <span class="n">pts2</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Find epilines corresponding to points in right image (second image) and</span>
        <span class="c1"># drawing its lines on left image</span>
        <span class="n">lines1</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">computeCorrespondEpilines</span><span class="p">(</span><span class="n">pts2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
        <span class="n">lines1</span> <span class="o">=</span> <span class="n">lines1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">img5</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">draw_lines</span><span class="p">(</span><span class="n">frameL</span><span class="p">,</span> <span class="n">frameR</span><span class="p">,</span><span class="n">lines1</span><span class="p">,</span><span class="n">pts1</span><span class="p">,</span><span class="n">pts2</span><span class="p">)</span>
        <span class="c1"># Find epilines corresponding to points in left image (first image) and</span>
        <span class="c1"># drawing its lines on right image</span>
        <span class="n">lines2</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">computeCorrespondEpilines</span><span class="p">(</span><span class="n">pts1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
        <span class="n">lines2</span> <span class="o">=</span> <span class="n">lines2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">img3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">draw_lines</span><span class="p">(</span><span class="n">frameR</span><span class="p">,</span> <span class="n">frameL</span><span class="p">,</span><span class="n">lines2</span><span class="p">,</span><span class="n">pts2</span><span class="p">,</span><span class="n">pts1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img5</span><span class="p">,</span> <span class="n">img3</span></div>

<div class="viewcode-block" id="StandardStereoBuilder.match"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameL</span><span class="p">,</span> <span class="n">frameR</span><span class="p">,</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">Matcher</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply stereo SGBM.</span>
<span class="sd">        </span>
<span class="sd">        Args: </span>
<span class="sd">            frameL: it&#39;s the left frame.</span>
<span class="sd">            frameR: it&#39;s the right frame.</span>
<span class="sd">            metrics: a boolean, if is true print by console the time of execution of correspondence step.</span>

<span class="sd">        Returns:</span>
<span class="sd">            left and right disparity maps and even matcher instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">left_matcher</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>
        <span class="n">right_matcher</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">ximgproc</span><span class="o">.</span><span class="n">createRightMatcher</span><span class="p">(</span><span class="n">left_matcher</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computing disparity...&#39;</span><span class="p">)</span> 
            <span class="n">matching_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">left_disp</span> <span class="o">=</span> <span class="n">left_matcher</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">frameL</span><span class="p">,</span> <span class="n">frameR</span><span class="p">)</span>
        <span class="n">right_disp</span> <span class="o">=</span> <span class="n">right_matcher</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">frameR</span><span class="p">,</span> <span class="n">frameL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matching time: </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">matching_time</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">left_disp</span><span class="p">,</span> <span class="n">right_disp</span><span class="p">,</span> <span class="n">left_matcher</span></div>
         
    
<div class="viewcode-block" id="StandardStereoBuilder.post_process"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.post_process">[docs]</a>    <span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameL</span><span class="p">,</span> <span class="n">left_disp</span><span class="p">,</span> <span class="n">right_disp</span><span class="p">,</span> <span class="n">matcher</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply wls filter in disparity maps to smooth contours.</span>
<span class="sd">        </span>
<span class="sd">        Args: </span>
<span class="sd">            frameL: it&#39;s the left frame.</span>
<span class="sd">            left_disp: it&#39;s the left disparity frame.</span>
<span class="sd">            right_disp: it&#39;s the right disparity frame.</span>
<span class="sd">            matcher: it&#39;s the matcher instance.</span>
<span class="sd">            lmbda: is a parameter defining the amount of regularization during filtering. Larger values force filtered disparity map edges to adhere more to source image edges. Typical value is 8000. Only valid in post processing step.</span>
<span class="sd">            sigma: is a parameter defining how sensitive the filtering process is to source image edges. Large values can lead to disparity leakage through low-contrast edges. Small values can make the filter too sensitive to noise and textures in the source image. Typical values range from 0.8 to 2.0. Only valid in post processing step</span>
<span class="sd">            metrics: if is true print by console the time of execution of post process step.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Improved disparity map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wls_filter</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">ximgproc</span><span class="o">.</span><span class="n">createDisparityWLSFilter</span><span class="p">(</span><span class="n">matcher</span><span class="p">)</span>
        <span class="n">wls_filter</span><span class="o">.</span><span class="n">setLambda</span><span class="p">(</span><span class="n">lmbda</span><span class="p">);</span>
        <span class="n">wls_filter</span><span class="o">.</span><span class="n">setSigmaColor</span><span class="p">(</span><span class="n">sigma</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">postprocessing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">filtered_disp</span> <span class="o">=</span> <span class="n">wls_filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">left_disp</span><span class="p">,</span> <span class="n">frameL</span><span class="p">,</span> <span class="n">disparity_map_right</span><span class="o">=</span><span class="n">right_disp</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;postprocessing time: </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">postprocessing_time</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filtered_disp</span></div>

<div class="viewcode-block" id="StandardStereoBuilder.estimate_disparity_colormap"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.estimate_disparity_colormap">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_disparity_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disparity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; It converts disparity maps with a shape of (w, h, 1) to  (w, h, 3).</span>

<span class="sd">        Args: </span>
<span class="sd">            disparity: a disparity map with a shape of (w, h, 1).</span>

<span class="sd">        Returns:</span>
<span class="sd">            disparity with color</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cv</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">((</span><span class="n">disparity</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">COLORMAP_JET</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="StandardStereoBuilder.estimate_depth_map"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.estimate_depth_map">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_depth_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disparity</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert disparity map to depth map.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame: left or right frame.</span>
<span class="sd">            disparity: a disparity map with a shape of (w, h, 1)</span>
<span class="sd">            Q: a 4x4 array with the following structure, [[1 0   0          -cx     ][0 1   0          -cy     ][0 0   0           f      ][0 0 -1/Tx (cx - cx&#39;)/Tx ]] cx: is the principal point x in left image, cx&#39;: is the principal point x in right image, cy: is the principal point y in left image, f: is the focal lenth in left image, Tx: The x coordinate in Translation matrix.  </span>
<span class="sd">            metrics: a boolean, if is true print by console the time of execution of depth map step.</span>

<span class="sd">        Returns:</span>
<span class="sd">            reprojected points image and a depth map in RGB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">get_3D_points_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">disparity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">reprojectImageTo3D</span><span class="p">(</span><span class="n">disparity</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">disparity</span> <span class="o">&gt;</span> <span class="n">disparity</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">out_points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">out_colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D points time: </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">get_3D_points_time</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out_points</span><span class="p">,</span> <span class="n">out_colors</span></div>

<div class="viewcode-block" id="StandardStereoBuilder.estimate_3D_points"><a class="viewcode-back" href="../../../module_stereo.html#py2vision.stereo.standard_stereo.StandardStereoBuilder.estimate_3D_points">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_3D_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">disparity</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert image plane points to homogeneous 3d points.</span>

<span class="sd">        Args:</span>
<span class="sd">            points: contains the (x, y) coordinates in image plane to convert to (X, Y, Z).</span>
<span class="sd">            disparity: a disparity map with a shape of (w, h, 1)</span>
<span class="sd">            Q: a 4x4 array with the following structure, [[1 0   0          -cx     ][0 1   0          -cy     ][0 0   0           f      ][0 0 -1/Tx (cx - cx&#39;)/Tx ]] cx: is the principal point x in left image, cx&#39;: is the principal point x in right image, cy: is the principal point y in left image, f: is the focal lenth in left image, Tx: The x coordinate in Translation matrix.  </span>

<span class="sd">        Returns:</span>
<span class="sd">            An array of points in 3D homogeneous coordinates (X, Y, Z, W).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">disparity</span><span class="p">)</span>
        <span class="n">homogeneous_3D_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">point_xy_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="p">[</span><span class="n">disparity</span><span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">projected_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">point_xy_disp</span><span class="p">)</span>
            <span class="n">homogeneous_3D_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projected_point</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">homogeneous_3D_points</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Guillermo Raven.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>